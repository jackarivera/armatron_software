<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>Armatron Motor Tuner</title>
  <link rel="stylesheet" href="theme.css">
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Control Panel Container -->
  <div class="container">
    <h1 id="motorHeader">Motor Control</h1>
    <!-- Dropdown to select joint for commands -->
    <div class="sub-section">
      <label for="jointSelectControl">Select Joint for Commands:</label>
      <select id="jointSelectControl" onchange="updateMotorHeader()">
        <option value="1">Joint 1</option>
        <option value="2">Joint 2</option>
        <option value="3">Joint 3</option>
        <option value="4">Joint 4</option>
        <option value="5">Joint 5</option>
        <option value="6">Joint 6</option>
        <option value="7">Joint 7</option>
      </select>
    </div>
    <!-- Command Buttons -->
    <button onclick="sendCmd({cmd:'motorOn', motorID:getSelectedJoint()})">Motor ON</button>
    <button onclick="sendCmd({cmd:'motorOff', motorID:getSelectedJoint()})">Motor OFF</button>
    <button onclick="sendCmd({cmd:'motorStop', motorID:getSelectedJoint()})">Motor STOP</button>
    <button onclick="clearMotorError()">Clear Motor Error</button>
    <hr>
    <!-- Flex layout for Real-Time Data Cards and Graph -->
    <div class="flex-wrapper">
      <div class="left-column">
        <h2>Real-Time Data (All Joints)</h2>
        <!-- Cards for each joint -->
        <div id="cardsContainer">
          <!-- These cards will be updated in real time -->
          <div class="card" id="card-1">
            <h3>Joint 1</h3>
            <div>Temperature: <span class="temp">--</span></div>
            <div>Torque: <span class="torque">--</span></div>
            <div>Speed: <span class="speed">--</span></div>
            <div>Single Loop Position: <span class="position">--</span></div>
            <div>Encoder: <span class="enc">--</span></div>
            <div>Error: <span class="error">--</span></div>
          </div>
          <div class="card" id="card-2"><h3>Joint 2</h3><div class="data">Waiting for data...</div></div>
          <div class="card" id="card-3"><h3>Joint 3</h3><div class="data">Waiting for data...</div></div>
          <div class="card" id="card-4"><h3>Joint 4</h3><div class="data">Waiting for data...</div></div>
          <div class="card" id="card-5"><h3>Joint 5</h3><div class="data">Waiting for data...</div></div>
          <div class="card" id="card-6"><h3>Joint 6</h3><div class="data">Waiting for data...</div></div>
          <div class="card" id="card-7"><h3>Joint 7</h3><div class="data">Waiting for data...</div></div>
        </div>
        <!-- Position & Torque Control -->
        <div class="sub-section">
          <h2>Position &amp; Torque Control</h2>
          <div>
            <label>Torque (raw):</label>
            <input id="torqueVal" type="number" value="50"/>
            <button onclick="applyTorque()">Set Torque</button>
          </div>
          <div>
            <label>Position (deg):</label>
            <input id="posVal" type="number" value="90"/>
            <label>MaxSpeed (dps):</label>
            <input id="posSpeedVal" type="number" value="360"/>
            <label>Spin Direction (0/1):</label>
            <input id="posSpinDir" type="number" value="0"/>
            <button onclick="applyPosition()">Set Position</button>
          </div>
        </div>
      </div>
      <div class="right-column">
        <!-- Motor Data Graph with joint selector -->
        <h2>Motor Data Graph</h2>
        <label for="jointSelectForGraph">Select Joint for Graph:</label>
        <select id="jointSelectForGraph" onchange="resetChartData()">
          <option value="1">Joint 1</option>
          <option value="2">Joint 2</option>
          <option value="3">Joint 3</option>
          <option value="4">Joint 4</option>
          <option value="5">Joint 5</option>
          <option value="6">Joint 6</option>
          <option value="7">Joint 7</option>
        </select>
        <button onclick="togglePause()">Pause/Resume Graph</button>
        <canvas id="myChart" width="300" height="150"></canvas>
      </div>
    </div>
  </div>

  <!-- Other controls remain in separate containers -->
  <div class="container">
    <h2>PID Gains (Write to ROM)</h2>
    <label>Angle Kp:</label>
    <input id="angKp" type="number" value="100"/>
    <label>Angle Ki:</label>
    <input id="angKi" type="number" value="50"/>
    <br/><br/>
    <label>Speed Kp:</label>
    <input id="spdKp" type="number" value="50"/>
    <label>Speed Ki:</label>
    <input id="spdKi" type="number" value="20"/>
    <br/><br/>
    <label>IQ Kp:</label>
    <input id="iqKp" type="number" value="50"/>
    <label>IQ Ki:</label>
    <input id="iqKi" type="number" value="50"/>
    <button onclick="writePID_ROM()">Write PID ROM</button>
  </div>

  <div class="container">
    <h2>Encoder / Zero</h2>
    <button onclick="readEncoder()">Read Encoder</button>
    <input id="encoderVal" type="number" value="0"/>
    <button onclick="writeEncoderZero()">Set Encoder Zero</button>
    <button onclick="writeCurrentPosZero()">Write Current Pos as Zero</button>
  </div>

  <div class="container">
    <h2>Acceleration</h2>
    <label>Accel (0.01 dps^2):</label>
    <input id="accelVal" type="number" value="1000"/>
    <button onclick="writeAcceleration()">Write Accel</button>
    <button onclick="readAcceleration()">Read Accel</button>
  </div>

  <script>
    let socket = io();
    let paused = false;
    let lastCommandValue = null;

    // Update header based on selected joint
    function updateMotorHeader() {
      let sel = document.getElementById('jointSelectControl').value;
      document.getElementById('motorHeader').innerText = "Motor #" + sel + " Control";
    }

    function getSelectedJoint() {
      return parseInt(document.getElementById("jointSelectControl").value);
    }

    // Send command to Node -> Daemon.
    function sendCmd(obj) {
      socket.emit('sendCommand', obj);
      if (obj.value !== undefined) {
        lastCommandValue = obj.value;
      }
    }

    function applyTorque() {
      let val = parseInt(document.getElementById('torqueVal').value);
      sendCmd({cmd:'setTorque', motorID:getSelectedJoint(), value: val});
    }

    function applyPosition() {
      let pos_val = parseInt(document.getElementById('posVal').value * 1000);
      let speed_val = parseInt(document.getElementById('posSpeedVal').value);
      let spin_dir = parseInt(document.getElementById('posSpinDir').value);
      sendCmd({
        cmd:'setSingleAngleWithSpeed',
        motorID:getSelectedJoint(),
        spinDirection: spin_dir,
        angle: pos_val,
        maxSpeed: speed_val
      });
    }

    function writePID_ROM() {
      let angKp = parseInt(document.getElementById('angKp').value);
      let angKi = parseInt(document.getElementById('angKi').value);
      let spdKp = parseInt(document.getElementById('spdKp').value);
      let spdKi = parseInt(document.getElementById('spdKi').value);
      let iqKp  = parseInt(document.getElementById('iqKp').value);
      let iqKi  = parseInt(document.getElementById('iqKi').value);
      sendCmd({
        cmd:'writePID_ROM',
        motorID:getSelectedJoint(),
        angKp, angKi, spdKp, spdKi, iqKp, iqKi
      });
    }

    function readEncoder() {
      sendCmd({cmd:'readEncoder', motorID:getSelectedJoint()});
    }
    function writeEncoderZero() {
      let val = parseInt(document.getElementById('encoderVal').value);
      sendCmd({cmd:'writeEncoderZero', motorID:getSelectedJoint(), encoderValue: val});
    }
    function writeCurrentPosZero() {
      sendCmd({cmd:'writeCurrentPosZero', motorID:getSelectedJoint()});
    }
    function writeAcceleration() {
      let val = parseInt(document.getElementById('accelVal').value);
      sendCmd({cmd:'writeAcceleration', motorID:getSelectedJoint(), accelVal: val});
    }
    function readAcceleration() {
      sendCmd({cmd:'readAcceleration', motorID:getSelectedJoint()});
    }
    function clearMotorError() {
      sendCmd({cmd:'clearMotorError', motorID:getSelectedJoint()});
    }

    // Chart.js configuration with four datasets.
    let ctx = document.getElementById('myChart').getContext('2d');
    let chartData = {
      labels: [],
      datasets: [
        {
          label: 'Position (deg)',
          data: [],
          borderColor: 'blue',
          fill: false,
        },
        {
          label: 'Speed (deg/s)',
          data: [],
          borderColor: 'red',
          fill: false,
        },
        {
          label: 'Commanded Input',
          data: [],
          borderColor: 'green',
          borderDash: [5,5],
          fill: false,
        },
        {
          label: 'Torque',
          data: [],
          borderColor: 'purple',
          fill: false,
        }
      ]
    };

    let myChart = new Chart(ctx, {
      type: 'line',
      data: chartData,
      options: {
        animation: false,
        scales: { x: { display: false } }
      }
    });

    function togglePause(){
      paused = !paused;
    }

    // Reset chart data when switching joints on the graph
    function resetChartData() {
      chartData.labels = [];
      chartData.datasets.forEach(ds => ds.data = []);
      myChart.update();
    }

    // Listen for motorStates from daemon.
    socket.on('motorStates', (msg) => {
      // Update each joint card.
      for (let i = 1; i <= 7; i++) {
        let card = document.getElementById("card-" + i);
        let motor = msg.motors[String(i)];
        if (motor) {
          // Create or update card content for the joint.
          card.innerHTML = `
            <h3>Joint ${i}</h3>
            <div>Temperature: <span class="temp">${motor.temp.toFixed(2)}</span></div>
            <div>Torque: <span class="torque">${motor.torqueA.toFixed(2)}</span></div>
            <div>Speed: <span class="speed">${motor.speedDeg_s.toFixed(2)}</span></div>
            <div>Single Loop Position: <span class="position">${(motor.posDeg / 10).toFixed(6)}</span></div>
            <div>Encoder: <span class="enc">${(motor.encoder_val).toFixed(6)}</span></div>
            <div>Error: <span class="error">${(motor.error && motor.error != 0) ? 'YES' : 'NO'}</span></div>
          `;
        } else {
          // Show disconnected status.
          card.innerHTML = `<h3>Joint ${i} - <span class="error-disconnected">Disconnected</span></h3>`;
        }
      }

      // Update the graph for the selected joint.
      let selectedGraphJoint = document.getElementById("jointSelectForGraph").value;
      let m = msg.motors[selectedGraphJoint];
      if (m && !paused) {
        let now = new Date().toLocaleTimeString();
        chartData.labels.push(now);
        chartData.datasets[0].data.push(m.posDeg / 10);
        chartData.datasets[1].data.push(m.speedDeg_s);
        chartData.datasets[2].data.push(lastCommandValue !== null ? lastCommandValue : null);
        chartData.datasets[3].data.push(m.torqueA);

        if (chartData.labels.length > 200) {
          chartData.labels.shift();
          chartData.datasets.forEach(ds => ds.data.shift());
        }
        myChart.update('none');
      }
    });
  </script>
</body>
</html>
